#!/usr/bin/env ruby
# dehashrocketify

# 20230331
# 0.9.3

# Changes since 0.8:
# 1. Accommodates weird patterns like: condition ? :first : :last => {}.
# 0/1
# 2. Fix {:key => value} case.
# 1/2
# 3. Fix (:key => value) case.
# 2/3
# 4. Fix ,:key => (Comma immediately in front of the colon.) case.
# 5. Added tests for {:key=>value} case
# 6. Added tests for { :key=>value } case.
# 7. Added tests for (:key=>value) case.
# 8. Added tests for ( :key=>value ) case.

def ruby_filenames
  if ARGV[0]
    if File.directory?(ARGV[0])
      Dir.glob("#{ARGV[0]}/**/*.{erb,rb,rabl,rake}")
    else
      Dir[ARGV[0]]
    end
  else
    Dir.glob("./**/*.{erb,rb,rabl,rake}")
  end
end

def main
  regex = /({|\( *|[^\:] +|,)\:(["']*[\w_-]+[?!]*["']*) *=>/
  ruby_filenames.each do |ruby_filename|
    contents = File.read(ruby_filename)
    if contents =~ regex
      new_contents = contents.gsub(regex, "\\1\\2:")
      File.write(ruby_filename, new_contents)
    end
  end
end

main
